<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Mandar Vaze" />
        <meta name="copyright" content="Mandar Vaze" />

        <meta name="twitter:creator" content="@mandarvaze">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="how-to, python, learning, tutorial, " />

<meta property="og:title" content="Token Based Authentication with Flask-Security "/>
<meta property="og:url" content="http://mandarvaze.github.io/2015/01/token-auth-with-flask-security.html" />
<meta property="og:description" content="Intro I&#39;m working on a Flask based API server (why Flask, why not xyz - is a topic for another discussion, but FWIW I am considering Django) As you know, Flask is a micro framework - that means a lot of &#34;features&#34; that are built-in into other frameworks aren&#39;t part of Flask …" />
<meta property="og:site_name" content="Desi Penguin&#39;s Blog" />
<meta property="og:article:author" content="Mandar Vaze" />
<meta property="og:article:published_time" content="2015-01-15T00:00:00+00:00" />
<meta property="" content="2015-02-03T00:00:00+00:00" />
<meta name="twitter:title" content="Token Based Authentication with Flask-Security ">
<meta name="twitter:description" content="Intro I&#39;m working on a Flask based API server (why Flask, why not xyz - is a topic for another discussion, but FWIW I am considering Django) As you know, Flask is a micro framework - that means a lot of &#34;features&#34; that are built-in into other frameworks aren&#39;t part of Flask …">
<meta property="og:image" content="http://mandarvaze.github.io/theme/images/apple-touch-icon-152x152.png" />
<meta name="twitter:image" content="http://mandarvaze.github.io/theme/images/apple-touch-icon-152x152.png" >

        <title>Token Based Authentication with Flask-Security  · Desi Penguin&#39;s Blog
</title>
        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://mandarvaze.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://mandarvaze.github.io/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://mandarvaze.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://mandarvaze.github.io/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="http://mandarvaze.github.io/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="http://mandarvaze.github.io/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="http://mandarvaze.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link href="http://mandarvaze.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Desi Penguin&#39;s Blog - Full Atom Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://mandarvaze.github.io/"><span class=site-name>Desi Penguin's Blog</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://mandarvaze.github.io">Home</a></li>
                            <li ><a href="http://mandarvaze.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://mandarvaze.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://mandarvaze.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://mandarvaze.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://mandarvaze.github.io/2015/01/token-auth-with-flask-security.html"> Token Based Authentication with Flask-Security  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#intro" id="id1">Intro</a></li>
<li><a class="reference internal" href="#define-user-and-roles" id="id2">Define User and Roles</a></li>
<li><a class="reference internal" href="#configurations" id="id3">Configurations</a></li>
<li><a class="reference internal" href="#api-endpoint" id="id4">API Endpoint</a></li>
<li><a class="reference internal" href="#lets-test" id="id5">Lets Test</a></li>
<li><a class="reference internal" href="#another-configuration" id="id6">Another Configuration</a></li>
<li><a class="reference internal" href="#get-the-token" id="id7">Get the Token</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            
<!-- 1  Intro
2  Define User and Roles
3  Configurations
4  API Endpoint
5  Lets Test
6  Another Configuration
7  Get the Token -->
<div class="section" id="intro">
<h2><a class="toc-backref" href="#id1">Intro</a></h2>
<p>I'm working on a Flask based API server (why Flask, why not xyz - is a topic for another discussion, but FWIW I am considering Django)</p>
<p>As you know, Flask is a micro framework - that means a lot of "features" that are built-in into other frameworks aren't part of Flask. But there are several third party Flask extension. Flask-Security is one of them (Flask-Restless is another one I'll be using)</p>
<p>Unfortunately, documentation for Flask-Security isn't up to the mark (at least as of this writing). I know this could be flame-bait, but it is not. Sometimes users need more sample code along with documentation, which seems to be missing here, and I am not alone. Just looking at the SO and other places people are "stuck" - lack of tutorials is evident.</p>
<p>I went thru the documentation, SO links, Google Searches, Flask-Security code walk thru, debugging that code, looking at the Flask-Security test cases. All of it finally was worth it, because I was able to get Token based Authentication to work.</p>
</div>
<div class="section" id="define-user-and-roles">
<h2><a class="toc-backref" href="#id2">Define User and Roles</a></h2>
<p>Basic code that defines the <tt class="docutils literal">User</tt> and <tt class="docutils literal">Role</tt> classes, initializes Flask-Security extension.
This is not different from what is available in the documentation (Except may be additional attributes for <tt class="docutils literal">User</tt> class)</p>
<div class="highlight"><pre><span></span><span class="c1"># A base model for other database tables to inherit</span>
<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__abstract__</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">())</span>
    <span class="n">modified_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">(),</span>
                            <span class="n">onupdate</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">())</span>


<span class="n">roles_users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">'roles_users'</span><span class="p">,</span>
                       <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span>
                                 <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'auth_user.id'</span><span class="p">)),</span>
                       <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'role_id'</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span>
                                 <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'auth_role.id'</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">RoleMixin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">'auth_role'</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'&lt;Role </span><span class="si">%r</span><span class="s1">&gt;'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">UserMixin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">'auth_user'</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">())</span>
    <span class="n">confirmed_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">last_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">current_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="c1"># Why 45 characters for IP Address ?</span>
    <span class="c1"># See http://stackoverflow.com/questions/166132/maximum-length-of-the-textual-representation-of-an-ipv6-address/166157#166157</span>
    <span class="n">last_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">45</span><span class="p">))</span>
    <span class="n">current_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">45</span><span class="p">))</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">'Role'</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">roles_users</span><span class="p">,</span>
                            <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">'dynamic'</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'&lt;User </span><span class="si">%r</span><span class="s1">&gt;'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>


<span class="c1"># Setup Flask-Security</span>
<span class="n">user_datastore</span> <span class="o">=</span> <span class="n">SQLAlchemyUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">)</span>
<span class="n">security</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">user_datastore</span><span class="p">)</span>


<span class="c1"># Create a user to test with</span>
<span class="nd">@app.before_first_request</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="n">user_datastore</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">'test@example.com'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">'test123'</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="configurations">
<h2><a class="toc-backref" href="#id3">Configurations</a></h2>
<p>In the <tt class="docutils literal">config.py</tt> I have following flask security configurations (for now - more will come)</p>
<div class="highlight"><pre><span></span><span class="n">SECURITY_PASSWORD_HASH</span> <span class="o">=</span> <span class="s1">'pbkdf2_sha512'</span>
<span class="n">SECURITY_TRACKABLE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">SECURITY_PASSWORD_SALT</span> <span class="o">=</span> <span class="s1">'something_super_secret_change_in_production'</span>
</pre></div>
</div>
<div class="section" id="api-endpoint">
<h2><a class="toc-backref" href="#id4">API Endpoint</a></h2>
<p>Add a dummy API endpoint like this :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">auth_token_required</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/dummy-api/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="nd">@auth_token_required</span>
<span class="k">def</span> <span class="nf">dummyAPI</span><span class="p">():</span>
    <span class="n">ret_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"Key1"</span><span class="p">:</span> <span class="s2">"Value1"</span><span class="p">,</span>
        <span class="s2">"Key2"</span><span class="p">:</span> <span class="s2">"value2"</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">ret_dict</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="lets-test">
<h2><a class="toc-backref" href="#id5">Lets Test</a></h2>
<p>Now all the pieces are set. Lets test.</p>
<p>Lets try whether authentication itself works.</p>
<p>First change  the <tt class="docutils literal">@auth_token_required</tt> decorator to <tt class="docutils literal">@http_auth_required</tt></p>
<p>Now you can now access the URL <tt class="docutils literal"><span class="pre">127.0.0.1:5001/dummy-api/</span></tt> via the browser.
You will see a pop up dialog that asks for the username and password</p>
<p>Enter the email as username and password we created earlier with <tt class="docutils literal">create_user</tt></p>
<p>If you dismiss without username password - you should see message starting with "Unauthorized"
If you entered the email and password correctly - you should see the dummy JSON data we returned in the browser page.</p>
<p>One other option is to use a program like curl or http (I prefer this. <tt class="docutils literal">pip install httpie</tt>) e.g.</p>
<div class="highlight"><pre><span></span>$ http <span class="m">127</span>.0.0.1:5001/dummy-api/
HTTP/1.0 <span class="m">401</span> UNAUTHORIZED
Content-Length: <span class="m">271</span>
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Date: Wed, <span class="m">14</span> Jan <span class="m">2015</span> <span class="m">07</span>:56:55 GMT
Server: Werkzeug/0.9.6 Python/3.4.0
Set-Cookie: <span class="nv">session</span><span class="o">=</span>eyJfaWQiOiIwZTMxMDBkNmMwNmY0MmQyNmU3MDBhYTZkMzUxZmM4OSJ9.B5eyxw.074cU7O6pJha_qomfuUOG2CvZNg<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
WWW-Authenticate: Basic <span class="nv">realm</span><span class="o">=</span><span class="s2">"Login Required"</span>

&lt;h1&gt;Unauthorized&lt;/h1&gt;
    &lt;p&gt;The server could not verify that you are authorized to access the URL
    requested. You either supplied the wrong credentials <span class="o">(</span>e.g. a bad password<span class="o">)</span>,
    or your browser doesn<span class="err">'</span>t understand how to supply the credentials required.&lt;/p&gt;
</pre></div>
<p>Now provide the authentication details, and see the expected response :</p>
<div class="highlight"><pre><span></span>$ http -a test@example.com:test123 <span class="m">127</span>.0.0.1:5001/dummy-api/
HTTP/1.0 <span class="m">200</span> OK
Content-Length: <span class="m">63</span>
Content-Type: application/json
Date: Wed, <span class="m">14</span> Jan <span class="m">2015</span> <span class="m">08</span>:03:50 GMT
Server: Werkzeug/0.9.6 Python/3.4.0
Set-Cookie: <span class="nv">session</span><span class="o">=</span>eyJfaWQiOiIwZTMxMDBkNmMwNmY0MmQyNmU3MDBhYTZkMzUxZmM4OSJ9.B5e0Zg.9-MG7d6XQ3zFnsNEz6NR7LtEC6Y<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/

<span class="o">{</span>
    <span class="s2">"items"</span>: <span class="o">{</span>
        <span class="s2">"Key1"</span>: <span class="s2">"Value1"</span>,
        <span class="s2">"Key2"</span>: <span class="s2">"value2"</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>So far so good. I was able to achieve this without too much trouble (Actually that is not true, but ..)</p>
<p>Lets move on to Token based Authentication. This is where things got a bit tricky (for me)
There seemed to be several people on SO with similar problems. (Hence this post - so that others in future can get some help)</p>
<p>First, before we forget, change the <tt class="docutils literal">@http_auth_required</tt> decorator back to <tt class="docutils literal">@auth_token_required</tt></p>
<p>Now to "get" the auth token. Per Flask Security documentation :</p>
<blockquote>
Token based authentication is enabled by retrieving the user auth token by
performing an HTTP POST with the authentication details as JSON data against
the authentication endpoint. A successful call to this endpoint will return
the user’s ID and their authentication token. This token can be used in
subsequent requests to protected resources.</blockquote>
<p>First of all - the documentation doesn't specify which <em>authentication endpoint</em> ?
Do I need to create one, or does Flask-Security provide me one by default ?</p>
<p>Turns out <tt class="docutils literal">/login</tt> is that default provided by Flask-Security
(An older post on flask mailing list mentioned <tt class="docutils literal">/auth</tt>. May be it was, in 2012. Not anymore)</p>
<p>Testing <tt class="docutils literal">http_auth</tt> was easy, also it was a <tt class="docutils literal">GET</tt> request. Performing <tt class="docutils literal">POST</tt> request isn't trivial.
At first I tried Postman client (Chrome Extension) - But it didn't work.</p>
<p>Then on SO - I came across <a class="reference external" href="http://stackoverflow.com/questions/24186694/combining-flask-restless-flask-security-and-regular-python-requests">this</a> post. While that person went with <cite>Flask-JWT</cite> - I didn't need to. It gave me an idea of using <cite>requests</cite> for the <cite>POST</cite> call.</p>
</div>
<div class="section" id="another-configuration">
<h2><a class="toc-backref" href="#id6">Another Configuration</a></h2>
<p>But before all is well - we need one entry in config.py as follows :</p>
<div class="highlight"><pre><span></span><span class="c1"># Without this get_auth_token via POST request w/ JSON data does not work</span>
<span class="c1"># You keep getting "CSRF token missing" error</span>
<span class="n">WTF_CSRF_ENABLED</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
<div class="section" id="get-the-token">
<h2><a class="toc-backref" href="#id7">Get the Token</a></h2>
<p>I did the following in ipython console - but one can very well convert this to a stand alone script, if needed.</p>
<div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">requests</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">json</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://127.0.0.1:5001/login'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">'email'</span><span class="p">:</span><span class="s1">'test@example.com'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">:</span><span class="s1">'test123'</span><span class="p">}),</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'content-type'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">23</span><span class="p">]:</span>
<span class="p">{</span><span class="s1">'meta'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'code'</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
 <span class="s1">'response'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'user'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'authentication_token'</span><span class="p">:</span> <span class="s1">'WyIxIiwiY2UwZWY0MDFjYTA3MmJlODcyODkzYjYxOGQzZjk4YzUiXQ.B5e5Sg.qcsDcaMgiRqx21YTC0OwwnihINM'</span><span class="p">,</span>
   <span class="s1">'id'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">}}}</span>
</pre></div>
<p>Now I can use this token with http as follows :</p>
<div class="highlight"><pre><span></span>$ http <span class="m">127</span>.0.0.1:5001/dummy-api/ Authentication-Token:WyIxIiwiY2UwZWY0MDFjYTA3MmJlODcyODkzYjYxOGQzZjk4YzUiXQ.B5e5Sg.qcsDcaMgiRqx21YTC0OwwnihINM
HTTP/1.0 <span class="m">200</span> OK
Content-Length: <span class="m">63</span>
Content-Type: application/json
Date: Wed, <span class="m">14</span> Jan <span class="m">2015</span> <span class="m">08</span>:26:48 GMT
Server: Werkzeug/0.9.6 Python/3.4.0
Set-Cookie: <span class="nv">session</span><span class="o">=</span>eyJfaWQiOiIwZTMxMDBkNmMwNmY0MmQyNmU3MDBhYTZkMzUxZmM4OSJ9.B5e5yA.Oog7nYYA6zSvWjyS7mVUUropKj8<span class="p">;</span> HttpOnly<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/

<span class="o">{</span>
    <span class="s2">"items"</span>: <span class="o">{</span>
        <span class="s2">"Key1"</span>: <span class="s2">"Value1"</span>,
        <span class="s2">"Key2"</span>: <span class="s2">"value2"</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Success !!!</p>
<p><em>Note: I'm yet to separate the Flask-Security related code into a separate file. When I did that hell broke loose. For now I have everything under myapp/__init__.py file. May be I'll cover that in another blog post</em></p>
</div>

            <section>
    <p id="post-share-links">
    Share on:
    <a href="http://twitter.com/home?status=b'Token%20Based%20Authentication%20with%20Flask-Security%20http%3A//mandarvaze.github.io/2015/01/token-auth-with-flask-security.html'" target="_blank" title="Share on Twitter">Twitter</a>
    ❄
    <a href="http://www.facebook.com/sharer/sharer.php?u=http%3A//mandarvaze.github.io/2015/01/token-auth-with-flask-security.html" target="_blank" title="Share on Facebook">Facebook</a>
    ❄
    <a href="https://plus.google.com/share?url=http%3A//mandarvaze.github.io/2015/01/token-auth-with-flask-security.html" target="_blank" title="Share on Google Plus">Google+</a>
    ❄
    <a href="mailto:?subject=Token%20Based%20Authentication%20with%20Flask-Security&amp;body=http%3A//mandarvaze.github.io/2015/01/token-auth-with-flask-security.html" target="_blank" title="Share via Email">Email</a>
    </p>
</section>

            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://mandarvaze.github.io/2015/01/token-auth-with-flask-security.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'desipenguinsblog';
        var disqus_identifier = 'http://mandarvaze.github.io/2015/01/token-auth-with-flask-security.html';
    var disqus_url = 'http://mandarvaze.github.io/2015/01/token-auth-with-flask-security.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://mandarvaze.github.io/2014/03/i-do-not-have-a-task.html" title="Previous: I do not have a task">I do not have a task</a></li>
                <li class="next-article"><a href="http://mandarvaze.github.io/2015/05/move-to-macbook.html" title="Next: Moving to Macbook">Moving to Macbook</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-01-15T00:00:00+00:00">Jan 15, 2015</time>

<h4>Last Updated</h4>
<time datetime="2015-02-03T00:00:00+00:00">Feb 3, 2015</time>

            <h4>Category</h4>
            <a class="category-link" href="http://mandarvaze.github.io/categories.html#tutorial-ref">tutorial</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://mandarvaze.github.io/tags.html#how-to-ref">how-to
                    <span>5</span>
</a></li>
                <li><a href="http://mandarvaze.github.io/tags.html#learning-ref">learning
                    <span>2</span>
</a></li>
                <li><a href="http://mandarvaze.github.io/tags.html#python-ref">python
                    <span>6</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://twitter.com/mandarvaze" title="My twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="https://www.linkedin.com/in/mandarvaze" title="My linkedin Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-linkedin sidebar-social-links"></i></a>
    <a href="http://github.com/mandarvaze" title="My github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'desipenguinsblog';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>